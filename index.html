<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ink Pay</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 400px;
      margin: 40px auto;
      text-align: center;
    }
    button, input[type="number"], input[type="text"], input[type="password"] {
      padding: 10px;
      margin: 10px 0;
      font-size: 16px;
      width: 80%;
      max-width: 300px;
    }
    #output, #formTransaksi, #infoToko, #initToko, #redeemBox {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 10px;
    }
    #formTransaksi, #infoToko, #mainInterface, #redeemBox {
      display: none;
    }
  </style>
</head>
<body>

  <h2>Ink Pay</h2>

  <!-- FORM INPUT TOKO -->
  <div id="initToko">
    <p>Masukkan nama toko kamu:</p>
    <input type="text" id="namaTokoInput" placeholder="Contoh: Kopi Biru">
    <br>
    <button id="masukBtn">Masuk</button>
  </div>

  <!-- MENU UTAMA -->
  <div id="mainInterface">
    <button id="cekSaldoBtn">Cek Saldo</button><br>
    <button id="transaksiBtn">Transaksi</button><br>
    <button id="infoBtn">Informasi Toko</button>
  </div>

  <!-- OUTPUT -->
  <div id="output">Silakan tempelkan kartu NFC.</div>

  <!-- FORM TRANSAKSI -->
  <div id="formTransaksi">
    <p>Masukkan harga transaksi:</p>
    <input type="number" id="hargaInput" placeholder="Contoh: 10000" min="1">
    <br>
    <button id="prosesBtn">Proses Transaksi</button>
  </div>

  <!-- INFORMASI TOKO -->
  <div id="infoToko">
    <p><strong>Nama Toko:</strong> <span id="namaTokoLabel"></span></p>
    <p><strong>Saldo Toko:</strong> Rp<span id="saldoTokoLabel"></span></p>
    <button id="redeemBtn">Redeem</button>

    <div id="redeemBox">
      <p><strong>Konfirmasi Admin:</strong><br>
      <small>Hanya bisa diisi oleh admin</small></p>
      <input type="password" id="adminPass" placeholder="Password admin">
      <br>
      <button id="confirmRedeemBtn">Konfirmasi Redeem</button>
    </div>
  </div>

  <script>
    let currentData = null;
    let namaToko = "";
    let saldoToko = 0;
    const ADMIN_PASSWORD = "admin123";

    const output = document.getElementById("output");
    const formTransaksi = document.getElementById("formTransaksi");
    const hargaInput = document.getElementById("hargaInput");
    const infoTokoDiv = document.getElementById("infoToko");
    const redeemBox = document.getElementById("redeemBox");

    function resetToMenu() {
      document.getElementById("mainInterface").style.display = "block";
      formTransaksi.style.display = "none";
      infoTokoDiv.style.display = "none";
    }

    document.getElementById("masukBtn").addEventListener("click", () => {
      const input = document.getElementById("namaTokoInput").value.trim();
      if (!input) {
        alert("Nama toko wajib diisi.");
        return;
      }
      namaToko = input;
      document.getElementById("initToko").style.display = "none";
      document.getElementById("mainInterface").style.display = "block";
      output.innerText = "Selamat datang di eMoney Seller.";
    });

    async function scanNFC(callback) {
      try {
        const ndef = new NDEFReader();
        await ndef.scan();
        output.innerText = "Tempelkan kartu NFC...";

        ndef.onreading = event => {
          const decoder = new TextDecoder();
          for (const record of event.message.records) {
            const text = decoder.decode(record.data);
            try {
              currentData = JSON.parse(text);
              callback(currentData);
            } catch {
              output.innerText = "Data tidak valid.";
            }
          }
        };
      } catch (err) {
        output.innerText = "⚠️ NFC Error: " + err;
      }
    }

    async function writeToNFC(data, afterWriteCallback) {
      try {
        const ndef = new NDEFReader();
        await ndef.write(JSON.stringify(data));
        afterWriteCallback();
      } catch (err) {
        output.innerText = "Gagal menulis ke kartu: " + err;
      }
    }

    document.getElementById("cekSaldoBtn").addEventListener("click", () => {
      resetToMenu();
      scanNFC(data => {
        output.innerHTML = `
          Nama: <strong>${data.name}</strong><br>
          Saldo: <strong>Rp${data.balance.toLocaleString()}</strong>
        `;
      });
    });

    document.getElementById("transaksiBtn").addEventListener("click", () => {
      formTransaksi.style.display = "block";
      infoTokoDiv.style.display = "none";
      output.innerText = "Masukkan harga, lalu tekan Proses.";
    });

    document.getElementById("prosesBtn").addEventListener("click", () => {
      const harga = parseInt(hargaInput.value);
      if (isNaN(harga) || harga <= 0) {
        alert("Masukkan harga yang valid.");
        return;
      }

      output.innerText = "Tempelkan kartu pembeli...";
      scanNFC(data => {
        if (data.balance < harga) {
          alert("❌ Saldo tidak cukup!");
          setTimeout(() => {
            output.innerText = "Transaksi gagal. Kembali ke menu.";
            resetToMenu();
          }, 2000);
          return;
        }

        data.balance -= harga;
        writeToNFC(data, () => {
          saldoToko += harga;
          alert("✅ Transaksi berhasil!");
          setTimeout(() => {
            output.innerText = "Transaksi selesai.";
            hargaInput.value = "";
            resetToMenu();
          }, 2000);
        });
      });
    });

    document.getElementById("infoBtn").addEventListener("click", () => {
      infoTokoDiv.style.display = "block";
      formTransaksi.style.display = "none";
      document.getElementById("namaTokoLabel").innerText = namaToko;
      document.getElementById("saldoTokoLabel").innerText = saldoToko.toLocaleString();
      redeemBox.style.display = "none";
    });

    document.getElementById("redeemBtn").addEventListener("click", () => {
      redeemBox.style.display = "block";
    });

    document.getElementById("confirmRedeemBtn").addEventListener("click", () => {
      const pass = document.getElementById("adminPass").value.trim();
      if (pass !== ADMIN_PASSWORD) {
        alert("❌ Password salah!");
        return;
      }
      saldoToko = 0;
      alert("✅ Saldo toko telah di-redeem.");
      document.getElementById("saldoTokoLabel").innerText = "0";
      redeemBox.style.display = "none";
    });
  </script>

</body>
</html>
