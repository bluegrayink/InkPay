<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>INK Pay</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 400px;
      margin: 40px auto;
      text-align: center;
    }
    button, input[type="text"], input[type="password"] {
      padding: 10px;
      margin: 10px 0;
      font-size: 16px;
      width: 80%;
      max-width: 300px;
    }
    #output, #formTransaksi, #infoToko, #initToko, #redeemBox {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 10px;
    }
    #formTransaksi, #infoToko, #mainInterface, #redeemBox {
      display: none;
    }
    .popup {
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      z-index: 1000;
      display: none;
    }
  </style>
</head>
<body>

  <h2>INK Pay</h2>

  <div id="popup" class="popup"></div>

  <!-- FORM INPUT TOKO -->
  <div id="initToko">
    <p>Masukkan nama toko kamu:</p>
    <input type="text" id="namaTokoInput" placeholder="Contoh: Kopi Biru">
    <br>
    <button id="masukBtn">Masuk</button>
  </div>

  <!-- MENU UTAMA -->
  <div id="mainInterface">
    <button id="cekSaldoBtn">📤 Cek Saldo</button><br>
    <button id="transaksiBtn">💳 Transaksi</button><br>
    <button id="infoBtn">🏪 Informasi Toko</button>
  </div>

  <!-- OUTPUT -->
  <div id="output">Silakan tempelkan kartu NFC.</div>

  <!-- FORM TRANSAKSI -->
  <div id="formTransaksi">
    <p>Masukkan harga transaksi:</p>
    <input type="text" id="hargaInput" placeholder="Contoh: 10.000">
    <br>
    <button id="prosesBtn">🔁 Proses Transaksi</button>
  </div>

  <!-- INFORMASI TOKO -->
  <div id="infoToko">
    <p><strong>Nama Toko:</strong> <span id="namaTokoLabel"></span></p>
    <p><strong>Saldo Toko:</strong> Rp<span id="saldoTokoLabel"></span></p>
    <button id="redeemBtn">🧾 Redeem</button>

    <div id="redeemBox">
      <p><strong>Konfirmasi Admin:</strong><br>
      <small>Hanya bisa diisi oleh admin</small></p>
      <input type="password" id="adminPass" placeholder="Password admin">
      <br>
      <button id="confirmRedeemBtn">🔓 Konfirmasi Redeem</button>
    </div>
  </div>

  <script>
    let currentData = null;
    let namaToko = "";
    let saldoToko = 0;
    const ADMIN_PASSWORD = "admin123";
    let activeScan = null; // hanya satu fungsi NFC aktif dalam waktu bersamaan

    const popup = document.getElementById("popup");

    function showPopup(message) {
      popup.innerText = message;
      popup.style.display = "block";
      setTimeout(() => {
        popup.style.display = "none";
      }, 2000);
    }

    function formatRupiah(value) {
      return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function parseRupiah(str) {
      return parseInt(str.replace(/\./g, '')) || 0;
    }

    document.getElementById("hargaInput").addEventListener("input", (e) => {
      const value = e.target.value.replace(/\D/g, "");
      e.target.value = formatRupiah(value);
    });

    function resetToMenu() {
      document.getElementById("mainInterface").style.display = "block";
      document.getElementById("formTransaksi").style.display = "none";
      document.getElementById("infoToko").style.display = "none";
      document.getElementById("redeemBox").style.display = "none";
      document.getElementById("hargaInput").value = "";
      activeScan = null;
    }

    document.getElementById("masukBtn").addEventListener("click", () => {
      const input = document.getElementById("namaTokoInput").value.trim();
      if (!input) {
        showPopup("❗ Nama toko wajib diisi.");
        return;
      }
      namaToko = input;
      document.getElementById("initToko").style.display = "none";
      document.getElementById("mainInterface").style.display = "block";
      document.getElementById("output").innerText = "Prototype V.1";
    });

    async function scanNFC(callback) {
      if (activeScan) return; // hanya satu pemindaian aktif
      try {
        const ndef = new NDEFReader();
        await ndef.scan();
        activeScan = true;
        document.getElementById("output").innerText = "Tempelkan kartu NFC...";

        ndef.onreading = event => {
          const decoder = new TextDecoder();
          for (const record of event.message.records) {
            const text = decoder.decode(record.data);
            try {
              currentData = JSON.parse(text);
              callback(currentData);
              activeScan = null;
            } catch {
              showPopup("❌ Data tidak valid.");
              activeScan = null;
            }
          }
        };
      } catch (err) {
        showPopup("⚠️ NFC Error: " + err);
        activeScan = null;
      }
    }

    async function writeToNFC(data, afterWriteCallback) {
      try {
        const ndef = new NDEFReader();
        await ndef.write(JSON.stringify(data));
        afterWriteCallback();
      } catch (err) {
        showPopup("❌ Gagal menulis ke kartu.");
      }
    }

    document.getElementById("cekSaldoBtn").addEventListener("click", () => {
      resetToMenu();
      scanNFC(data => {
        document.getElementById("output").innerHTML = `
          👤 Nama: <strong>${data.name}</strong><br>
          💰 Saldo: <strong>Rp${formatRupiah(data.balance)}</strong>
        `;
      });
    });

    document.getElementById("transaksiBtn").addEventListener("click", () => {
      resetToMenu();
      document.getElementById("formTransaksi").style.display = "block";
      document.getElementById("output").innerText = "Masukkan harga, lalu tekan Proses.";
    });

    document.getElementById("prosesBtn").addEventListener("click", () => {
      const harga = parseRupiah(document.getElementById("hargaInput").value);
      if (harga <= 0) {
        showPopup("❗ Harga tidak valid.");
        return;
      }

      document.getElementById("output").innerText = "Tempelkan kartu pembeli...";
      scanNFC(data => {
        if (data.balance < harga) {
          showPopup("❌ Saldo tidak cukup.");
          setTimeout(() => resetToMenu(), 2000);
          return;
        }

        data.balance -= harga;
        writeToNFC(data, () => {
          saldoToko += harga;
          showPopup("✅ Transaksi berhasil.");
          setTimeout(() => {
            document.getElementById("output").innerText = "Transaksi selesai.";
            resetToMenu();
          }, 2000);
        });
      });
    });

    document.getElementById("infoBtn").addEventListener("click", () => {
      resetToMenu();
      document.getElementById("infoToko").style.display = "block";
      document.getElementById("namaTokoLabel").innerText = namaToko;
      document.getElementById("saldoTokoLabel").innerText = formatRupiah(saldoToko);
    });

    document.getElementById("redeemBtn").addEventListener("click", () => {
      document.getElementById("redeemBox").style.display = "block";
    });

    document.getElementById("confirmRedeemBtn").addEventListener("click", () => {
      const pass = document.getElementById("adminPass").value.trim();
      if (pass !== ADMIN_PASSWORD) {
        showPopup("❌ Password salah!");
        return;
      }
      saldoToko = 0;
      showPopup("✅ Saldo toko berhasil di-redeem.");
      document.getElementById("saldoTokoLabel").innerText = formatRupiah(saldoToko);
      document.getElementById("redeemBox").style.display = "none";
    });
  </script>

</body>
</html>
